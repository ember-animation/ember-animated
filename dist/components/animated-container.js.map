{"version":3,"file":"animated-container.js","sources":["../../src/components/animated-container.ts"],"sourcesContent":["import { inject as service } from '@ember/service';\nimport Component from '@ember/component';\nimport { alias } from '@ember/object/computed';\nimport { action } from '@ember/object';\nimport { Resize } from '../motions/resize.ts';\nimport { task, type Task } from '../-private/ember-scheduler.ts';\nimport Sprite from '../-private/sprite.ts';\nimport { afterRender, microwait } from '../-private/concurrency-helpers.ts';\nimport { componentNodes } from '../-private/ember-internals.ts';\nimport type MotionService from '../services/-ea-motion.ts';\nimport type { MotionConstructor } from '../-private/motion.ts';\nimport type Owner from '@ember/owner';\n\ninterface AnimatedContainerSignature<Tag extends string> {\n  /** Multiple tags supported for base element via `tag` arg */\n  // Element: ElementFromTagName<Tag>; // @todo https://github.com/typed-ember/glint/issues/610\n  Element: HTMLDivElement;\n  Args: {\n    motion?: string;\n\n    /** Whether to animate the initial render. You will probably also need to set initialInsertion=true on a child component of animated-container. Defaults to false. */\n    onInitialRender?: boolean;\n\n    /** Use a custom tag for the container. Defaults to div. */\n    tag?: Tag;\n    class?: string;\n  };\n  Blocks: {\n    default: [];\n  };\n}\n\n/**\n Provides a boundary between animator components and the surrounding document\n which smoothly resizes as animators change. Use animated-container whenever you\n need to \"hold a place for\" some animated content while that content is animating.\n  ```hbs\n  <button {{on \"click\" this.toggleThing}}>Toggle</button>\n  <AnimatedContainer>\n    {{#animated-if this.showThing use=this.transition }}\n        <div class=\"message\" {{on \"click\" this.toggleThing}}>\n            Hello!\n        </div>\n    {{/animated-if}}\n  </AnimatedContainer>\n  <p>\n    This is outside of the container.\n  </p>\n  ```\n  ```js\n  import Component from '@ember/component';\n  import { action } from '@ember/object';\n  import { tracked } from '@glimmer/tracking';\n  import move from 'ember-animated/motions/move';\n  import { easeOut, easeIn } from 'ember-animated/easings/cosine';\n\n  export default class AnimatedContainerComponentExample extends Component {\n    @tracked showThing = false;\n\n    @action\n    toggleThing() {\n      this.showThing = !this.showThing;\n    }\n\n    *transition({ insertedSprites, keptSprites, removedSprites }) {\n      for (let sprite of insertedSprites) {\n        sprite.startAtPixel({ x: window.innerWidth });\n        yield move(sprite, { easing: easeOut });\n      }\n\n      for (let sprite of keptSprites) {\n        yield move(sprite);\n      }\n\n      for (let sprite of removedSprites) {\n        sprite.endAtPixel({ x: window.innerWidth });\n        yield move(sprite, { easing: easeIn });\n      }\n    }\n  }\n  ```\n  @class animated-container\n  @public\n*/\nexport default class AnimatedContainerComponent<\n  Tag extends string = 'div',\n> extends Component<AnimatedContainerSignature<Tag>> {\n  tagName = '';\n\n  @service('-ea-motion')\n  motionService!: MotionService;\n\n  /**\n   * Use a custom tag for the container. Defaults to div.\n    @argument tag\n    @type String\n  */\n  tag = 'div' as const;\n  // @todo https://github.com/typed-ember/glint/issues/610\n  // tag: Tag = 'div' as Tag;\n\n  /**\n   * Whether to animate the initial render. You will probably also need to set\n   * initialInsertion=true on a child component of animated-container.\n   * Defaults to false.\n    @argument onInitialRender\n    @type Boolean\n  */\n  onInitialRender = false;\n\n  /**\n   * Use a custom motion to resize the container. Defaults to `Resize`.\n    @argument motion\n    @type String\n  */\n  motion: MotionConstructor = Resize;\n\n  private _inserted = false;\n  private _startingUp = false;\n  private sprite: Sprite | null = null;\n\n  constructor(properties: Owner | undefined) {\n    super(properties);\n    this.motionService\n      .register(this as any)\n      .observeDescendantAnimations(this as any, this.maybeAnimate); // TODO: shouldn't need this cast;\n  }\n\n  didInsertElement() {\n    super.didInsertElement();\n    this._inserted = true;\n  }\n\n  private _ownElement() {\n    if (!this._inserted) {\n      return undefined;\n    }\n    let { firstNode, lastNode } = componentNodes(this);\n    let node: Node | null = firstNode;\n    while (node) {\n      if (node.nodeType === Node.ELEMENT_NODE) {\n        return node as HTMLElement | SVGElement;\n      }\n      if (node === lastNode) {\n        break;\n      }\n      node = node.nextSibling;\n    }\n    return undefined;\n  }\n\n  willDestroyElement() {\n    super.willDestroyElement();\n    this.motionService\n      .unregister(this as any)\n      .unobserveDescendantAnimations(this as any, this.maybeAnimate); // TODO: shouldn't need this cast\n  }\n\n  @alias('animated.isRunning')\n  isAnimating!: boolean;\n\n  @action\n  maybeAnimate({ duration, task }: { duration: number; task: Promise<void> }) {\n    if (!this._startingUp) {\n      this.animate.perform(duration, task);\n    }\n  }\n\n  beginStaticMeasurement() {\n    if (this.sprite) {\n      this.sprite.unlock();\n    }\n  }\n\n  endStaticMeasurement() {\n    if (this.sprite) {\n      this.sprite.lock();\n    }\n  }\n\n  @(task(function* (\n    this: AnimatedContainerComponent,\n    duration: number,\n    animationTask: Promise<void>,\n  ) {\n    this._startingUp = true;\n    let service = this.motionService;\n    let sprite: Sprite;\n    let useMotion;\n    let element = this._ownElement();\n\n    if (element) {\n      sprite = Sprite.sizedStartingAt(element);\n      this.sprite = sprite;\n      sprite.lock();\n      useMotion = true;\n    } else {\n      useMotion = this.onInitialRender;\n    }\n\n    try {\n      yield afterRender();\n      yield microwait();\n    } finally {\n      this._startingUp = false;\n    }\n\n    yield* service.staticMeasurement(() => {\n      if (!sprite) {\n        // ownElement is non-null here because we waited for render above, and\n        // our own template definitely contains an Element\n        sprite = Sprite.sizedEndingAt(this._ownElement()!);\n        this.sprite = sprite;\n      } else {\n        sprite.measureFinalBounds();\n      }\n    });\n\n    if (useMotion) {\n      yield* new this.motion(this.sprite!, { duration })._run();\n    }\n\n    yield animationTask;\n\n    this.sprite!.unlock();\n    this.sprite = null;\n  }).restartable())\n  animate!: Task;\n}\n"],"names":["AnimatedContainerComponent","Component","tagName","g","prototype","service","i","void 0","tag","onInitialRender","motion","Resize","_inserted","_startingUp","sprite","constructor","properties","motionService","register","observeDescendantAnimations","maybeAnimate","didInsertElement","_ownElement","undefined","firstNode","lastNode","componentNodes","node","nodeType","Node","ELEMENT_NODE","nextSibling","willDestroyElement","unregister","unobserveDescendantAnimations","alias","duration","task","animate","perform","n","action","beginStaticMeasurement","unlock","endStaticMeasurement","lock","animationTask","useMotion","element","Sprite","sizedStartingAt","afterRender","microwait","staticMeasurement","sizedEndingAt","measureFinalBounds","_run","restartable","setComponentTemplate","TEMPLATE"],"mappings":"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"}