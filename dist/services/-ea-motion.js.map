{"version":3,"file":"-ea-motion.js","sources":["../../src/services/-ea-motion.ts"],"sourcesContent":["import type EmberObject from '@ember/object';\nimport { computed } from '@ember/object';\nimport { A } from '@ember/array';\nimport Service from '@ember/service';\nimport type { Task } from '../-private/ember-scheduler.ts';\nimport { task } from '../-private/ember-scheduler.ts';\nimport {\n  microwait,\n  rAF,\n  afterRender,\n  allSettled,\n} from '../-private/concurrency-helpers.ts';\nimport type Sprite from '../-private/sprite.ts';\nimport type Child from '../-private/child';\nimport type { Transition } from '../-private/transition.ts';\n\ninterface Animator extends EmberObject {\n  beginStaticMeasurement(): void;\n  endStaticMeasurement(): void;\n  isAnimating: boolean;\n}\n\nexport type OrphanObserver = (\n  removed: Sprite[],\n  transition: Transition,\n  duration: number,\n  shouldAnimateRemoved: boolean,\n) => void;\n\ntype AnimationObserver = (args: {\n  task: Promise<void>;\n  duration: number;\n}) => void;\n\ntype AncestorObserver = (state: Child['state']) => void;\n\ninterface BaseComponentLike extends EmberObject {\n  parentView: ComponentLike | undefined;\n}\n\ninterface AnimatedListElement extends BaseComponentLike {\n  isEmberAnimatedListElement: true;\n  child: Child;\n}\n\ntype ComponentLike = BaseComponentLike | AnimatedListElement;\n\ninterface Measurement {\n  fn: () => void;\n  resolved: boolean;\n  value: any;\n}\n\ninterface Rendezvous {\n  inserted: Sprite[];\n  kept: Sprite[];\n  removed: Sprite[];\n  matches: Map<Sprite, Sprite>;\n  runAnimationTask: Promise<void>;\n  otherTasks: Map<Promise<void>, true>;\n}\n\nexport default class MotionService extends Service {\n  _rendezvous: Rendezvous[] = [];\n  _measurements: Measurement[] = [];\n  _animators = A<Animator>();\n  _orphanObserver: OrphanObserver | null = null;\n  _animationObservers: AnimationObserver[] = [];\n  _descendantObservers: {\n    component: ComponentLike;\n    fn: AnimationObserver;\n  }[] = [];\n  _ancestorObservers: WeakMap<ComponentLike, Map<AncestorObserver, string>> =\n    new WeakMap();\n  _beacons: { [name: string]: Sprite } | null = null;\n\n  // === Notification System ===\n\n  // Ever animator should register and unregister itself so we know\n  // when there are any animations running. Animators are required to\n  // have:\n  //    - an isAnimating property\n  //    - beginStaticMeasurement and endStaticMeasurement methods\n  register(animator: Animator) {\n    this._animators.pushObject(animator);\n    return this;\n  }\n  unregister(animator: Animator) {\n    this._animators.removeObject(animator);\n    return this;\n  }\n\n  // Register to receive any sprites that are orphaned by a destroyed\n  // animator.\n  observeOrphans(fn: OrphanObserver) {\n    if (this._orphanObserver) {\n      throw new Error(\n        'Only one animated-orphans component can be used at one time',\n      );\n    }\n    this._orphanObserver = fn;\n    return this;\n  }\n  unobserveOrphans(fn: OrphanObserver) {\n    if (this._orphanObserver === fn) {\n      this._orphanObserver = null;\n    }\n    return this;\n  }\n\n  // Register to know when an animation is starting anywhere in the app.\n  observeAnimations(fn: AnimationObserver) {\n    this._animationObservers.push(fn);\n    return this;\n  }\n  unobserveAnimations(fn: AnimationObserver) {\n    let index = this._animationObservers.indexOf(fn);\n    if (index !== -1) {\n      this._animationObservers.splice(index, 1);\n    }\n    return this;\n  }\n\n  // Register to know when an animation is starting within the\n  // descendants of the given component\n  observeDescendantAnimations(component: ComponentLike, fn: AnimationObserver) {\n    this._descendantObservers.push({ component, fn });\n    return this;\n  }\n  unobserveDescendantAnimations(\n    component: ComponentLike,\n    fn: AnimationObserver,\n  ) {\n    let entry = this._descendantObservers.find(\n      (e) => e.component === component && e.fn === fn,\n    );\n    if (entry) {\n      this._descendantObservers.splice(\n        this._descendantObservers.indexOf(entry),\n        1,\n      );\n    }\n    return this;\n  }\n\n  // Register to know when an animation is starting among the\n  // ancestors of the given component. The fn will be told whether\n  // component is going to be destroyed or not at the end of the\n  // animation.\n  observeAncestorAnimations(component: ComponentLike, fn: AncestorObserver) {\n    let id;\n    for (let ancestorComponent of ancestorsOf(component)) {\n      // when we find an animated list element, we save its ID\n      if ('isEmberAnimatedListElement' in ancestorComponent) {\n        id = ancestorComponent.child.id;\n      } else if (id != null) {\n        // if we found an ID on the last loop, now we've got the list\n        // element's parent which is the actual animator.\n        let observers = this._ancestorObservers.get(ancestorComponent);\n        if (!observers) {\n          this._ancestorObservers.set(\n            ancestorComponent,\n            (observers = new Map()),\n          );\n        }\n        observers.set(fn, id);\n        id = null;\n      }\n    }\n    return this;\n  }\n  unobserveAncestorAnimations(component: ComponentLike, fn: AncestorObserver) {\n    for (let ancestorComponent of ancestorsOf(component)) {\n      let observers = this._ancestorObservers.get(ancestorComponent);\n      if (observers) {\n        observers.delete(fn);\n      }\n    }\n    return this;\n  }\n\n  // This is a publicly visible property you can use to know if any animations\n  // are running. It's timing is deliberately not synchronous, so that you can\n  // bind it into a template without getting double-render errors.\n  //\n  // We have an un-observed dependency on an internal property *on purpose*, so\n  // this lint rule needs to be disabled:\n  //\n  // eslint-disable-next-line ember/require-computed-property-dependencies\n  @computed()\n  get isAnimating(): boolean {\n    return this.isAnimatingSync;\n  }\n\n  // Synchronously updated version of isAnimating. If you try to\n  // depend on this in a template you will get double-render errors\n  // (because the act of rendering can cause animations to begin).\n  @computed('_animators.@each.isAnimating')\n  get isAnimatingSync() {\n    return this._animators.any((animator) => animator.isAnimating);\n  }\n\n  // Invalidation support for isAnimating\n  @task(function* (this: MotionService) {\n    yield rAF();\n    this.notifyPropertyChange('isAnimating');\n  }).observes('isAnimatingSync')\n  _invalidateIsAnimating!: Task;\n\n  @task(function* (this: MotionService) {\n    // we are idle if we experience two frames in a row with nothing\n    // animating.\n    while (true) {\n      yield rAF();\n      if (!this.isAnimatingSync) {\n        yield rAF();\n        if (!this.isAnimatingSync) {\n          return;\n        }\n      }\n    }\n  })\n  waitUntilIdle!: Task;\n\n  matchDestroyed(\n    removed: Sprite[],\n    transition: Transition,\n    duration: number,\n    shouldAnimateRemoved: boolean,\n  ) {\n    if (this._orphanObserver && removed.length > 0) {\n      // if these orphaned sprites may be capable of animating,\n      // delegate them to the orphanObserver. It will do farMatching\n      // for them.\n      this._orphanObserver(removed, transition, duration, shouldAnimateRemoved);\n    } else {\n      // otherwise, we make them available for far matching but they\n      // can't be animated.\n      this.farMatch.perform(null, [], [], removed, true);\n    }\n  }\n\n  hasBeacon(name: string) {\n    return this._beacons?.[name];\n  }\n\n  @task(function* (this: MotionService, name: string, beacon: Sprite) {\n    if (!this._beacons) {\n      this._beacons = {};\n    }\n    this._beacons[name] = beacon;\n    // allows other farMatches to start\n    yield microwait();\n    // allows other farMatches to finish\n    yield microwait();\n    this._beacons = null;\n  })\n  addBeacon!: Task;\n\n  @task(function* (\n    this: MotionService,\n    runAnimationTask: Promise<void>,\n    inserted: Sprite[],\n    kept: Sprite[],\n    removed: Sprite[],\n    longWait = false,\n  ) {\n    let matches = new Map() as Map<Sprite, Sprite>;\n    let mine = {\n      inserted,\n      kept,\n      removed,\n      matches,\n      runAnimationTask,\n      otherTasks: new Map(),\n    };\n    this._rendezvous.push(mine);\n    yield microwait();\n    if (longWait) {\n      // used by matchDestroyed because it gets called earlier in the\n      // render cycle, so it needs to linger longer in order to\n      // coincide with other farMatches.\n      yield afterRender();\n      yield microwait();\n      yield microwait();\n    }\n\n    if (this.farMatch.concurrency > 1) {\n      this._rendezvous.forEach((target) => {\n        if (target === mine) {\n          return;\n        }\n        performMatches(mine, target);\n        performMatches(target, mine);\n      });\n    }\n    this._rendezvous.splice(this._rendezvous.indexOf(mine), 1);\n    return {\n      farMatches: matches,\n      matchingAnimatorsFinished: allSettled([...mine.otherTasks.keys()]),\n      beacons: this._beacons,\n    };\n  })\n  farMatch!: Task;\n\n  willAnimate({\n    task,\n    duration,\n    component,\n    children,\n  }: {\n    task: Promise<void>;\n    duration: number;\n    component: ComponentLike;\n    children: Child[];\n  }) {\n    let message = { task, duration };\n\n    // tell any of our ancestors who are observing their descendants\n    let ancestors = [...ancestorsOf(component)];\n    for (let { component: observingComponent, fn } of this\n      ._descendantObservers) {\n      if (ancestors.indexOf(observingComponent) !== -1) {\n        fn(message);\n      }\n    }\n\n    // tell any of our descendants who are observing their ancestors\n    let observers = this._ancestorObservers.get(component);\n    if (observers) {\n      for (let [fn, id] of observers.entries()) {\n        let child = children.find((child) => child.id === id);\n        if (child) {\n          fn(child.state);\n        } // the else case here applies to descendants that are about\n        // to be unrendered (not animated away -- immediately\n        // dropped). They will still have an opportunity to animate\n        // too, but they do it via their own willDestroyElement\n        // hook, not the this early-warning hook.\n      }\n    }\n\n    // tell anybody who is listening for all animations\n    for (let fn of this._animationObservers) {\n      fn(message);\n    }\n  }\n\n  *staticMeasurement(fn: Measurement['fn']) {\n    let measurement: Measurement = { fn, resolved: false, value: null };\n    this._measurements.push(measurement);\n    try {\n      // allow all concurrent animators to join in with our single\n      // measurement step instead of having each trigger its own reflow.\n      yield microwait();\n\n      if (!measurement.resolved) {\n        // we are the first concurrent task to wake up, so we do the\n        // actual resolution for everyone.\n        let animators = this._animators;\n        animators.forEach((animator) => animator.beginStaticMeasurement());\n        this._measurements.forEach((m) => {\n          try {\n            m.value = m.fn();\n          } catch (err) {\n            setTimeout(function () {\n              throw err;\n            }, 0);\n          }\n          m.resolved = true;\n        });\n        animators.forEach((animator) => animator.endStaticMeasurement());\n      }\n      return measurement.value;\n    } finally {\n      this._measurements.splice(this._measurements.indexOf(measurement), 1);\n    }\n  }\n}\n\nfunction performMatches(sink: Rendezvous, source: Rendezvous) {\n  sink.inserted.concat(sink.kept).forEach((sprite) => {\n    let match = source.removed.find(\n      // TODO: an OwnedSprite type could eliminate the need for these\n      // non-nullable casts.\n      (mySprite) =>\n        sprite.owner!.group == mySprite.owner!.group &&\n        sprite.owner!.id === mySprite.owner!.id,\n    );\n    if (match) {\n      sink.matches.set(sprite, match);\n      sink.otherTasks.set(source.runAnimationTask, true);\n      source.matches.set(match, sprite);\n      source.otherTasks.set(sink.runAnimationTask, true);\n    }\n  });\n}\n\nfunction* ancestorsOf(component: ComponentLike) {\n  let pointer = component.parentView;\n  while (pointer) {\n    yield pointer;\n    pointer = pointer.parentView;\n  }\n}\n\ndeclare module '@ember/service' {\n  interface Registry {\n    '-ea-motion': MotionService;\n  }\n}\n"],"names":["MotionService","_dec","computed","_dec2","_dec3","task","rAF","notifyPropertyChange","observes","_dec4","isAnimatingSync","_dec5","name","beacon","_beacons","microwait","_dec6","runAnimationTask","inserted","kept","removed","longWait","matches","Map","mine","otherTasks","_rendezvous","push","afterRender","farMatch","concurrency","forEach","target","performMatches","splice","indexOf","farMatches","matchingAnimatorsFinished","allSettled","keys","beacons","_class","Service","constructor","args","_defineProperty","A","WeakMap","_initializerDefineProperty","_descriptor","_descriptor2","_descriptor3","_descriptor4","register","animator","_animators","pushObject","unregister","removeObject","observeOrphans","fn","_orphanObserver","Error","unobserveOrphans","observeAnimations","_animationObservers","unobserveAnimations","index","observeDescendantAnimations","component","_descendantObservers","unobserveDescendantAnimations","entry","find","e","observeAncestorAnimations","id","ancestorComponent","ancestorsOf","child","observers","_ancestorObservers","get","set","unobserveAncestorAnimations","delete","isAnimating","any","matchDestroyed","transition","duration","shouldAnimateRemoved","length","perform","hasBeacon","willAnimate","children","message","ancestors","observingComponent","entries","state","staticMeasurement","measurement","resolved","value","_measurements","animators","beginStaticMeasurement","m","err","setTimeout","endStaticMeasurement","_applyDecoratedDescriptor","prototype","Object","getOwnPropertyDescriptor","configurable","enumerable","writable","initializer","sink","source","concat","sprite","match","mySprite","owner","group","pointer","parentView"],"mappings":"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"}