{"version":3,"file":"move.js","sources":["../../src/motions/move.ts"],"sourcesContent":["import { rAF } from '../-private/concurrency-helpers.ts';\nimport Motion, { type BaseOptions } from '../-private/motion.ts';\nimport type Sprite from '../-private/sprite.ts';\nimport Tween, { type TweenLike } from '../-private/tween.ts';\n\n/**\n  Animates _sprite_ from its initial position to its final position.\n\n  _sprite_ must have both `initialBounds` and `finalBounds` set.\n\n  ```js\n  for (let sprite of keptSprites) {\n    move(sprite)\n  }\n  ```\n\n  @function move\n  @export default\n  @param {Sprite} sprite\n  @return {Motion}\n*/\nexport default function move(sprite: Sprite, opts: Partial<MoveOptions> = {}) {\n  return new Move(sprite, opts).run();\n}\n\nexport interface MoveOptions extends BaseOptions {\n  easing: (time: number) => number;\n}\n\nexport class Move<T extends MoveOptions = MoveOptions> extends Motion<T> {\n  prior: Move | undefined | null = null;\n  xTween: TweenLike | null = null;\n  yTween: TweenLike | null = null;\n\n  interrupted(motions: Motion[]) {\n    // We only need to track the prior Move we are replacing here,\n    // because it will have done the same for any earlier ones.\n    // SAFETY: We know this is a Move because we checked the instance type.\n    this.prior = motions.find((m) => m instanceof Move) as Move | undefined;\n  }\n\n  *animate() {\n    let duration = this.duration;\n\n    this.sprite.assertHasInitialBounds();\n    this.sprite.assertHasFinalBounds();\n    let sprite = this.sprite;\n\n    // How far our sprite needs to move.\n    let dx, dy;\n    {\n      let initial = sprite.initialBounds;\n      let final = sprite.finalBounds;\n      dx = final.left - initial.left;\n      dy = final.top - initial.top;\n    }\n\n    if (!this.prior) {\n      // when starting a new move we start from its current position\n      // (sprite.transform) and offset that based on the change in\n      // bounds we want.\n      this.xTween = new Tween(\n        sprite.transform.tx,\n        sprite.transform.tx + dx,\n        fuzzyZero(dx) ? 0 : duration,\n        this.opts.easing,\n      );\n\n      this.yTween = new Tween(\n        sprite.transform.ty,\n        sprite.transform.ty + dy,\n        fuzzyZero(dy) ? 0 : duration,\n        this.opts.easing,\n      );\n    } else {\n      let prior: Move = this.prior;\n      prior.assertHasTweens();\n\n      // Here we are interrupting a prior Move.\n      let priorXTween = prior.xTween;\n      let priorYTween = prior.yTween;\n\n      // The transformDiffs account for the fact that our old and new\n      // tweens may be measuring from different origins.\n      let transformDiffX = sprite.transform.tx - priorXTween.currentValue;\n      let transformDiffY = sprite.transform.ty - priorYTween.currentValue;\n\n      // We adjust our move distances so that they cancel out the\n      // remainder of the previous move.\n      dx -= priorXTween.finalValue - priorXTween.currentValue;\n      dy -= priorYTween.finalValue - priorYTween.currentValue;\n\n      // If our interrupting move is actually going to the same place\n      // we were already going, we don't really want to extend the\n      // time of the overall animation (it looks funny when you're\n      // waiting around for nothing to happen).\n      let durationX = fuzzyZero(dx) ? 0 : duration;\n      let durationY = fuzzyZero(dy) ? 0 : duration;\n\n      // We add our new differential tweens to the prior tweens. This\n      // is the magic that gives us smooth continuity. At the very\n      // start, the old tween will dominate because the new tween\n      // hasn't ramped up its motion yet. As the old tween finishes,\n      // the new tween begins to dominate. Because of the adjustments\n      // we did above, the sum of both tweens will end up right where\n      // we want to be.\n      this.xTween = new Tween(\n        transformDiffX,\n        transformDiffX + dx,\n        durationX,\n        this.opts.easing,\n      ).plus(prior.xTween);\n      this.yTween = new Tween(\n        transformDiffY,\n        transformDiffY + dy,\n        durationY,\n        this.opts.easing,\n      ).plus(prior.yTween);\n    }\n\n    yield* this._moveIt();\n  }\n\n  *_moveIt() {\n    this.assertHasTweens();\n    let sprite = this.sprite;\n    while (!this.xTween.done || !this.yTween.done) {\n      sprite.translate(\n        this.xTween.currentValue - sprite.transform.tx,\n        this.yTween.currentValue - sprite.transform.ty,\n      );\n      yield rAF();\n    }\n  }\n\n  assertHasTweens(): asserts this is MoveWithTweens {\n    if (!this.xTween) {\n      throw new Error(`motion does not have xTween`);\n    }\n    if (!this.yTween) {\n      throw new Error(`motion does not have yTween`);\n    }\n  }\n}\n\ninterface MoveWithTweens extends Move {\n  xTween: TweenLike;\n  yTween: TweenLike;\n}\n\n// Because sitting around while your sprite animates by 3e-15 pixels\n// is no fun.\nfunction fuzzyZero(number: number) {\n  return Math.abs(number) < 0.00001;\n}\n\nexport function continuePrior(sprite: Sprite, opts: Partial<MoveOptions> = {}) {\n  return new ContinuePrior(sprite, opts).run();\n}\n\nexport class ContinuePrior extends Move {\n  *animate() {\n    if (!this.prior) {\n      return;\n    }\n    this.xTween = this.prior.xTween;\n    this.yTween = this.prior.yTween;\n    yield* this._moveIt();\n  }\n}\n"],"names":["move","sprite","opts","Move","run","Motion","constructor","args","_defineProperty","interrupted","motions","prior","find","m","animate","duration","assertHasInitialBounds","assertHasFinalBounds","dx","dy","initial","initialBounds","final","finalBounds","left","top","xTween","Tween","transform","tx","fuzzyZero","easing","yTween","ty","assertHasTweens","priorXTween","priorYTween","transformDiffX","currentValue","transformDiffY","finalValue","durationX","durationY","plus","_moveIt","done","translate","rAF","Error","number","Math","abs","continuePrior","ContinuePrior"],"mappings":";;;;;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACe,SAASA,IAAIA,CAACC,MAAc,EAAEC,IAA0B,GAAG,EAAE,EAAE;EAC5E,OAAO,IAAIC,IAAI,CAACF,MAAM,EAAEC,IAAI,CAAC,CAACE,GAAG,EAAE,CAAA;AACrC,CAAA;AAMO,MAAMD,IAAI,SAA8CE,MAAM,CAAI;AAAAC,EAAAA,WAAAA,CAAA,GAAAC,IAAA,EAAA;AAAA,IAAA,KAAA,CAAA,GAAAA,IAAA,CAAA,CAAA;AAAAC,IAAAA,eAAA,gBACtC,IAAI,CAAA,CAAA;AAAAA,IAAAA,eAAA,iBACV,IAAI,CAAA,CAAA;AAAAA,IAAAA,eAAA,iBACJ,IAAI,CAAA,CAAA;AAAA,GAAA;EAE/BC,WAAWA,CAACC,OAAiB,EAAE;AAC7B;AACA;AACA;AACA,IAAA,IAAI,CAACC,KAAK,GAAGD,OAAO,CAACE,IAAI,CAAEC,CAAC,IAAKA,CAAC,YAAYV,IAAI,CAAqB,CAAA;AACzE,GAAA;EAEA,CAACW,OAAOA,GAAG;AACT,IAAA,IAAIC,QAAQ,GAAG,IAAI,CAACA,QAAQ,CAAA;AAE5B,IAAA,IAAI,CAACd,MAAM,CAACe,sBAAsB,EAAE,CAAA;AACpC,IAAA,IAAI,CAACf,MAAM,CAACgB,oBAAoB,EAAE,CAAA;AAClC,IAAA,IAAIhB,MAAM,GAAG,IAAI,CAACA,MAAM,CAAA;;AAExB;IACA,IAAIiB,EAAE,EAAEC,EAAE,CAAA;AACV,IAAA;AACE,MAAA,IAAIC,OAAO,GAAGnB,MAAM,CAACoB,aAAa,CAAA;AAClC,MAAA,IAAIC,KAAK,GAAGrB,MAAM,CAACsB,WAAW,CAAA;AAC9BL,MAAAA,EAAE,GAAGI,KAAK,CAACE,IAAI,GAAGJ,OAAO,CAACI,IAAI,CAAA;AAC9BL,MAAAA,EAAE,GAAGG,KAAK,CAACG,GAAG,GAAGL,OAAO,CAACK,GAAG,CAAA;AAC9B,KAAA;AAEA,IAAA,IAAI,CAAC,IAAI,CAACd,KAAK,EAAE;AACf;AACA;AACA;AACA,MAAA,IAAI,CAACe,MAAM,GAAG,IAAIC,KAAK,CACrB1B,MAAM,CAAC2B,SAAS,CAACC,EAAE,EACnB5B,MAAM,CAAC2B,SAAS,CAACC,EAAE,GAAGX,EAAE,EACxBY,SAAS,CAACZ,EAAE,CAAC,GAAG,CAAC,GAAGH,QAAQ,EAC5B,IAAI,CAACb,IAAI,CAAC6B,MACZ,CAAC,CAAA;AAED,MAAA,IAAI,CAACC,MAAM,GAAG,IAAIL,KAAK,CACrB1B,MAAM,CAAC2B,SAAS,CAACK,EAAE,EACnBhC,MAAM,CAAC2B,SAAS,CAACK,EAAE,GAAGd,EAAE,EACxBW,SAAS,CAACX,EAAE,CAAC,GAAG,CAAC,GAAGJ,QAAQ,EAC5B,IAAI,CAACb,IAAI,CAAC6B,MACZ,CAAC,CAAA;AACH,KAAC,MAAM;AACL,MAAA,IAAIpB,KAAW,GAAG,IAAI,CAACA,KAAK,CAAA;MAC5BA,KAAK,CAACuB,eAAe,EAAE,CAAA;;AAEvB;AACA,MAAA,IAAIC,WAAW,GAAGxB,KAAK,CAACe,MAAM,CAAA;AAC9B,MAAA,IAAIU,WAAW,GAAGzB,KAAK,CAACqB,MAAM,CAAA;;AAE9B;AACA;MACA,IAAIK,cAAc,GAAGpC,MAAM,CAAC2B,SAAS,CAACC,EAAE,GAAGM,WAAW,CAACG,YAAY,CAAA;MACnE,IAAIC,cAAc,GAAGtC,MAAM,CAAC2B,SAAS,CAACK,EAAE,GAAGG,WAAW,CAACE,YAAY,CAAA;;AAEnE;AACA;AACApB,MAAAA,EAAE,IAAIiB,WAAW,CAACK,UAAU,GAAGL,WAAW,CAACG,YAAY,CAAA;AACvDnB,MAAAA,EAAE,IAAIiB,WAAW,CAACI,UAAU,GAAGJ,WAAW,CAACE,YAAY,CAAA;;AAEvD;AACA;AACA;AACA;MACA,IAAIG,SAAS,GAAGX,SAAS,CAACZ,EAAE,CAAC,GAAG,CAAC,GAAGH,QAAQ,CAAA;MAC5C,IAAI2B,SAAS,GAAGZ,SAAS,CAACX,EAAE,CAAC,GAAG,CAAC,GAAGJ,QAAQ,CAAA;;AAE5C;AACA;AACA;AACA;AACA;AACA;AACA;MACA,IAAI,CAACW,MAAM,GAAG,IAAIC,KAAK,CACrBU,cAAc,EACdA,cAAc,GAAGnB,EAAE,EACnBuB,SAAS,EACT,IAAI,CAACvC,IAAI,CAAC6B,MACZ,CAAC,CAACY,IAAI,CAAChC,KAAK,CAACe,MAAM,CAAC,CAAA;MACpB,IAAI,CAACM,MAAM,GAAG,IAAIL,KAAK,CACrBY,cAAc,EACdA,cAAc,GAAGpB,EAAE,EACnBuB,SAAS,EACT,IAAI,CAACxC,IAAI,CAAC6B,MACZ,CAAC,CAACY,IAAI,CAAChC,KAAK,CAACqB,MAAM,CAAC,CAAA;AACtB,KAAA;AAEA,IAAA,OAAO,IAAI,CAACY,OAAO,EAAE,CAAA;AACvB,GAAA;EAEA,CAACA,OAAOA,GAAG;IACT,IAAI,CAACV,eAAe,EAAE,CAAA;AACtB,IAAA,IAAIjC,MAAM,GAAG,IAAI,CAACA,MAAM,CAAA;AACxB,IAAA,OAAO,CAAC,IAAI,CAACyB,MAAM,CAACmB,IAAI,IAAI,CAAC,IAAI,CAACb,MAAM,CAACa,IAAI,EAAE;MAC7C5C,MAAM,CAAC6C,SAAS,CACd,IAAI,CAACpB,MAAM,CAACY,YAAY,GAAGrC,MAAM,CAAC2B,SAAS,CAACC,EAAE,EAC9C,IAAI,CAACG,MAAM,CAACM,YAAY,GAAGrC,MAAM,CAAC2B,SAAS,CAACK,EAC9C,CAAC,CAAA;MACD,MAAMc,GAAG,EAAE,CAAA;AACb,KAAA;AACF,GAAA;AAEAb,EAAAA,eAAeA,GAAmC;AAChD,IAAA,IAAI,CAAC,IAAI,CAACR,MAAM,EAAE;AAChB,MAAA,MAAM,IAAIsB,KAAK,CAAE,CAAA,2BAAA,CAA4B,CAAC,CAAA;AAChD,KAAA;AACA,IAAA,IAAI,CAAC,IAAI,CAAChB,MAAM,EAAE;AAChB,MAAA,MAAM,IAAIgB,KAAK,CAAE,CAAA,2BAAA,CAA4B,CAAC,CAAA;AAChD,KAAA;AACF,GAAA;AACF,CAAA;AAOA;AACA;AACA,SAASlB,SAASA,CAACmB,MAAc,EAAE;AACjC,EAAA,OAAOC,IAAI,CAACC,GAAG,CAACF,MAAM,CAAC,GAAG,OAAO,CAAA;AACnC,CAAA;AAEO,SAASG,aAAaA,CAACnD,MAAc,EAAEC,IAA0B,GAAG,EAAE,EAAE;EAC7E,OAAO,IAAImD,aAAa,CAACpD,MAAM,EAAEC,IAAI,CAAC,CAACE,GAAG,EAAE,CAAA;AAC9C,CAAA;AAEO,MAAMiD,aAAa,SAASlD,IAAI,CAAC;EACtC,CAACW,OAAOA,GAAG;AACT,IAAA,IAAI,CAAC,IAAI,CAACH,KAAK,EAAE;AACf,MAAA,OAAA;AACF,KAAA;AACA,IAAA,IAAI,CAACe,MAAM,GAAG,IAAI,CAACf,KAAK,CAACe,MAAM,CAAA;AAC/B,IAAA,IAAI,CAACM,MAAM,GAAG,IAAI,CAACrB,KAAK,CAACqB,MAAM,CAAA;AAC/B,IAAA,OAAO,IAAI,CAACY,OAAO,EAAE,CAAA;AACvB,GAAA;AACF;;;;"}