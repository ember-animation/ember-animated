{"version":3,"file":"tween.js","sources":["../../src/-private/tween.ts"],"sourcesContent":["import { rAF, frameState, clock } from './concurrency-helpers.ts';\nimport { easeInAndOut } from '../easings/cosine.ts';\nimport { getOrCreate } from './singleton.ts';\n\nconst currentCurves = getOrCreate<MotionCurve[]>('tween', () => []);\n\nexport interface TweenLike {\n  currentValue: number;\n  finalValue: number;\n  done: boolean;\n}\n\n/*\n  A Tween automatically recalculates on demand at most once per\n  animation frame. As long as you're using the rAF helper from\n  './concurrency-helpers', it will always be fresh. When many\n  concurrent Tweens are running over the same duration at the same\n  time, we can avoid a lot of duplicate work and keep them in sync.\n*/\n\nexport default class Tween implements TweenLike {\n  private curve: MotionCurve;\n  private diff: number;\n\n  constructor(\n    readonly initialValue: number,\n    readonly finalValue: number,\n    duration: number,\n    easing = easeInAndOut,\n  ) {\n    if (typeof easing !== 'function') {\n      throw new Error('Tried to make a Tween with an invalid easing function');\n    }\n    this.curve = MotionCurve.findOrCreate(duration, easing);\n    this.diff = finalValue - initialValue;\n  }\n  get currentValue() {\n    return this.initialValue + this.diff * this.curve.spaceProgress;\n  }\n  get done() {\n    return this.curve.done;\n  }\n  plus(otherTween: TweenLike) {\n    return new DerivedTween(\n      [this, otherTween],\n      (a: TweenLike, b: TweenLike) => a.currentValue + b.currentValue,\n    );\n  }\n}\n\nexport class DerivedTween implements TweenLike {\n  private _finalValue: number | null = null;\n  private inputs: TweenLike[];\n\n  constructor(\n    inputs: TweenLike[],\n    private combinator: (...inputs: TweenLike[]) => number,\n  ) {\n    this._finalValue = null;\n    this.inputs = inputs.map((t) => {\n      if (t.done) {\n        // If one of our inputs has already finished, we can just keep its final\n        // value around and drop the reference to the original Tween. This\n        // prevents long chains of derived tweens from growing without bound\n        // during continuous animations.\n        return new Tween(t.currentValue, t.currentValue, 0);\n      } else {\n        return t;\n      }\n    });\n  }\n  get finalValue() {\n    if (this._finalValue == null) {\n      let accum = 0;\n      for (const input of this.inputs) {\n        accum += input.finalValue;\n      }\n      this._finalValue = accum;\n    }\n    return this._finalValue;\n  }\n  get currentValue() {\n    return this.combinator(...this.inputs);\n  }\n  get done(): boolean {\n    return !this.inputs.find((t) => !t.done);\n  }\n}\n\nclass MotionCurve {\n  // we share motion curves among all concurrent motions that have the\n  // same duration that start in the same animation frame.\n  static findOrCreate(duration: number, easing: (t: number) => number) {\n    let shared = currentCurves.find(\n      (c) => c.duration === duration && c.easing === easing,\n    );\n    if (shared) {\n      return shared;\n    }\n    let created = new this(duration, easing);\n    currentCurves.push(created);\n    rAF().then(() => {\n      currentCurves.splice(currentCurves.indexOf(created), 1);\n    });\n    return created;\n  }\n\n  private startTime: number;\n  private _doneFrames = 0;\n  private _lastTick: number | undefined;\n  private _runTime: number | undefined;\n  private _timeProgress: number | undefined;\n  private _spaceProgress: number | undefined;\n\n  constructor(\n    readonly duration: number,\n    private easing: (t: number) => number,\n  ) {\n    this.startTime = clock.now();\n    this._tick();\n  }\n  _tick() {\n    if (this._lastTick !== frameState.currentFrameClock) {\n      this._lastTick = frameState.currentFrameClock;\n      this._runTime = clock.now() - this.startTime;\n      this._timeProgress =\n        this.duration === 0 ? 1 : Math.min(this._runTime / this.duration, 1);\n      this._spaceProgress = this.easing(this._timeProgress);\n      if (this._timeProgress >= 1) {\n        this._doneFrames++;\n      }\n    }\n  }\n  get runTime() {\n    this._tick();\n    return this._runTime!;\n  }\n  get timeProgress() {\n    this._tick();\n    return this._timeProgress!;\n  }\n  get spaceProgress() {\n    this._tick();\n    return this._spaceProgress!;\n  }\n\n  // Tweens are not considered done until they have been done for more\n  // than one frame. This allows you to write animations like:\n  //\n  //     while (!tween.done) {\n  //       doSomethingWith(tween.currentValue);\n  //       yield rAF();\n  //     }\n  //\n  // while being sure that doSomethingWith will actually be called at\n  // least once with the final value. The alternative ways to\n  // accomplish that:\n  //\n  //     while (!tween.done) {\n  //       yield rAF(); // <-- may cause flicker\n  //       doSomethingWith(tween.currentValue);\n  //      }\n  //\n  //  or\n  //\n  //     while (!tween.done) {\n  //       doSomethingWith(tween.currentValue);\n  //       yield rAF();\n  //     }\n  //     doSomethingWith(tween.currentValue);\n  //\n  //  Either allow flicker or require animation authors to remember to\n  //  repeat themselves.\n  get done() {\n    this._tick();\n    return this._doneFrames > 1;\n  }\n}\n"],"names":["currentCurves","getOrCreate","Tween","constructor","initialValue","finalValue","duration","easing","easeInAndOut","_defineProperty","Error","curve","MotionCurve","findOrCreate","diff","currentValue","spaceProgress","done","plus","otherTween","DerivedTween","a","b","inputs","combinator","_finalValue","map","t","accum","input","find","shared","c","created","push","rAF","then","splice","indexOf","startTime","clock","now","_tick","_lastTick","frameState","currentFrameClock","_runTime","_timeProgress","Math","min","_spaceProgress","_doneFrames","runTime","timeProgress"],"mappings":"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"}