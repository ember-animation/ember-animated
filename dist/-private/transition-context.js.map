{"version":3,"file":"transition-context.js","sources":["../../src/-private/transition-context.ts"],"sourcesContent":["import { childrenSettled } from './scheduler.ts';\nimport type Sprite from './sprite.ts';\nimport type { Transition } from './transition.ts';\nimport { getOrCreate } from './singleton.ts';\n\nconst spriteContext = getOrCreate('transition-context', () => new WeakMap());\n\nexport function* runToCompletion(\n  context: TransitionContext,\n  transition: Transition,\n) {\n  yield* transition(context);\n  yield childrenSettled();\n}\n\nexport default class TransitionContext {\n  static forSprite(sprite: Sprite): TransitionContext {\n    return spriteContext.get(sprite);\n  }\n\n  private _prepared: Set<Sprite> = new Set();\n\n  prepareSprite: ((sprite: Sprite) => Sprite) | undefined;\n\n  constructor(\n    private _duration: number,\n    private _insertedSprites: Sprite[],\n    private _keptSprites: Sprite[],\n    private _removedSprites: Sprite[],\n    private _sentSprites: Sprite[],\n    private _receivedSprites: Sprite[],\n    private _beacons: { [name: string]: Sprite },\n    readonly onMotionStart: (sprite: Sprite) => void,\n    readonly onMotionEnd: (sprite: Sprite) => void,\n  ) {}\n\n  // the following things are all accessors in order to make them\n  // read-only, and to let us tell which classes of sprites a user's\n  // transition is actually using.\n\n  get duration() {\n    return this._duration;\n  }\n  get insertedSprites() {\n    return this._prepareSprites(this._insertedSprites);\n  }\n  get keptSprites() {\n    return this._prepareSprites(this._keptSprites);\n  }\n  get removedSprites() {\n    return this._prepareSprites(this._removedSprites);\n  }\n  get sentSprites() {\n    return this._prepareSprites(this._sentSprites);\n  }\n  get receivedSprites() {\n    return this._prepareSprites(this._receivedSprites);\n  }\n\n  get beacons() {\n    return this._beacons;\n  }\n\n  private _prepareSprites(sprites: Sprite[]): Sprite[] {\n    // Link them up, so that users can conveniently pass sprites\n    // around to Motions without also passing the transition context.\n    sprites.forEach((sprite) => {\n      spriteContext.set(sprite, this);\n    });\n    if (!this.prepareSprite) {\n      return sprites;\n    }\n    return sprites.map((sprite) => {\n      if (!this._prepared.has(sprite)) {\n        this._prepared.add(sprite);\n        sprite = this.prepareSprite!(sprite);\n      }\n      return sprite;\n    });\n  }\n}\n"],"names":["spriteContext","getOrCreate","WeakMap","runToCompletion","context","transition","childrenSettled","TransitionContext","forSprite","sprite","get","_prepared","Set","prepareSprite","constructor","_duration","_insertedSprites","_keptSprites","_removedSprites","_sentSprites","_receivedSprites","_beacons","onMotionStart","onMotionEnd","duration","insertedSprites","_prepareSprites","keptSprites","removedSprites","sentSprites","receivedSprites","beacons","sprites","forEach","set","map","has","add"],"mappings":";;;AAKA,MAAMA,aAAa,GAAGC,WAAW,CAAC,oBAAoB,EAAE,MAAM,IAAIC,OAAO,EAAE,CAAC;AAErE,UAAUC,eAAeA,CAC9BC,OAA0B,EAC1BC,UAAsB,EACtB;EACA,OAAOA,UAAU,CAACD,OAAO,CAAC;EAC1B,MAAME,eAAe,EAAE;AACzB;AAEe,MAAMC,iBAAiB,CAAC;EACrC,OAAOC,SAASA,CAACC,MAAc,EAAqB;AAClD,IAAA,OAAOT,aAAa,CAACU,GAAG,CAACD,MAAM,CAAC;AAClC;AAEQE,EAAAA,SAAS,GAAgB,IAAIC,GAAG,EAAE;EAE1CC,aAAa;AAEbC,EAAAA,WAAWA,CACDC,SAAiB,EACjBC,gBAA0B,EAC1BC,YAAsB,EACtBC,eAAyB,EACzBC,YAAsB,EACtBC,gBAA0B,EAC1BC,QAAoC,EACnCC,aAAuC,EACvCC,WAAqC,EAC9C;IAAA,IATQR,CAAAA,SAAiB,GAAjBA,SAAiB;IAAA,IACjBC,CAAAA,gBAA0B,GAA1BA,gBAA0B;IAAA,IAC1BC,CAAAA,YAAsB,GAAtBA,YAAsB;IAAA,IACtBC,CAAAA,eAAyB,GAAzBA,eAAyB;IAAA,IACzBC,CAAAA,YAAsB,GAAtBA,YAAsB;IAAA,IACtBC,CAAAA,gBAA0B,GAA1BA,gBAA0B;IAAA,IAC1BC,CAAAA,QAAoC,GAApCA,QAAoC;IAAA,IACnCC,CAAAA,aAAuC,GAAvCA,aAAuC;IAAA,IACvCC,CAAAA,WAAqC,GAArCA,WAAqC;AAC7C;;AAEH;AACA;AACA;;EAEA,IAAIC,QAAQA,GAAG;IACb,OAAO,IAAI,CAACT,SAAS;AACvB;EACA,IAAIU,eAAeA,GAAG;AACpB,IAAA,OAAO,IAAI,CAACC,eAAe,CAAC,IAAI,CAACV,gBAAgB,CAAC;AACpD;EACA,IAAIW,WAAWA,GAAG;AAChB,IAAA,OAAO,IAAI,CAACD,eAAe,CAAC,IAAI,CAACT,YAAY,CAAC;AAChD;EACA,IAAIW,cAAcA,GAAG;AACnB,IAAA,OAAO,IAAI,CAACF,eAAe,CAAC,IAAI,CAACR,eAAe,CAAC;AACnD;EACA,IAAIW,WAAWA,GAAG;AAChB,IAAA,OAAO,IAAI,CAACH,eAAe,CAAC,IAAI,CAACP,YAAY,CAAC;AAChD;EACA,IAAIW,eAAeA,GAAG;AACpB,IAAA,OAAO,IAAI,CAACJ,eAAe,CAAC,IAAI,CAACN,gBAAgB,CAAC;AACpD;EAEA,IAAIW,OAAOA,GAAG;IACZ,OAAO,IAAI,CAACV,QAAQ;AACtB;EAEQK,eAAeA,CAACM,OAAiB,EAAY;AACnD;AACA;AACAA,IAAAA,OAAO,CAACC,OAAO,CAAExB,MAAM,IAAK;AAC1BT,MAAAA,aAAa,CAACkC,GAAG,CAACzB,MAAM,EAAE,IAAI,CAAC;AACjC,KAAC,CAAC;AACF,IAAA,IAAI,CAAC,IAAI,CAACI,aAAa,EAAE;AACvB,MAAA,OAAOmB,OAAO;AAChB;AACA,IAAA,OAAOA,OAAO,CAACG,GAAG,CAAE1B,MAAM,IAAK;MAC7B,IAAI,CAAC,IAAI,CAACE,SAAS,CAACyB,GAAG,CAAC3B,MAAM,CAAC,EAAE;AAC/B,QAAA,IAAI,CAACE,SAAS,CAAC0B,GAAG,CAAC5B,MAAM,CAAC;AAC1BA,QAAAA,MAAM,GAAG,IAAI,CAACI,aAAa,CAAEJ,MAAM,CAAC;AACtC;AACA,MAAA,OAAOA,MAAM;AACf,KAAC,CAAC;AACJ;AACF;;;;"}