{"version":3,"file":"transition-context.js","sources":["../../src/-private/transition-context.ts"],"sourcesContent":["import { childrenSettled } from './scheduler.ts';\nimport type Sprite from './sprite.ts';\nimport type { Transition } from './transition.ts';\nimport { getOrCreate } from './singleton.ts';\n\nconst spriteContext = getOrCreate('transition-context', () => new WeakMap());\n\nexport function* runToCompletion(\n  context: TransitionContext,\n  transition: Transition,\n) {\n  yield* transition(context);\n  yield childrenSettled();\n}\n\nexport default class TransitionContext {\n  static forSprite(sprite: Sprite): TransitionContext {\n    return spriteContext.get(sprite);\n  }\n\n  private _prepared: Set<Sprite> = new Set();\n\n  prepareSprite: ((sprite: Sprite) => Sprite) | undefined;\n\n  constructor(\n    private _duration: number,\n    private _insertedSprites: Sprite[],\n    private _keptSprites: Sprite[],\n    private _removedSprites: Sprite[],\n    private _sentSprites: Sprite[],\n    private _receivedSprites: Sprite[],\n    private _beacons: { [name: string]: Sprite },\n    readonly onMotionStart: (sprite: Sprite) => void,\n    readonly onMotionEnd: (sprite: Sprite) => void,\n  ) {}\n\n  // the following things are all accessors in order to make them\n  // read-only, and to let us tell which classes of sprites a user's\n  // transition is actually using.\n\n  get duration() {\n    return this._duration;\n  }\n  get insertedSprites() {\n    return this._prepareSprites(this._insertedSprites);\n  }\n  get keptSprites() {\n    return this._prepareSprites(this._keptSprites);\n  }\n  get removedSprites() {\n    return this._prepareSprites(this._removedSprites);\n  }\n  get sentSprites() {\n    return this._prepareSprites(this._sentSprites);\n  }\n  get receivedSprites() {\n    return this._prepareSprites(this._receivedSprites);\n  }\n\n  get beacons() {\n    return this._beacons;\n  }\n\n  private _prepareSprites(sprites: Sprite[]): Sprite[] {\n    // Link them up, so that users can conveniently pass sprites\n    // around to Motions without also passing the transition context.\n    sprites.forEach((sprite) => {\n      spriteContext.set(sprite, this);\n    });\n    if (!this.prepareSprite) {\n      return sprites;\n    }\n    return sprites.map((sprite) => {\n      if (!this._prepared.has(sprite)) {\n        this._prepared.add(sprite);\n        sprite = this.prepareSprite!(sprite);\n      }\n      return sprite;\n    });\n  }\n}\n"],"names":["spriteContext","getOrCreate","WeakMap","runToCompletion","context","transition","childrenSettled","TransitionContext","forSprite","sprite","get","constructor","_duration","_insertedSprites","_keptSprites","_removedSprites","_sentSprites","_receivedSprites","_beacons","onMotionStart","onMotionEnd","_defineProperty","Set","duration","insertedSprites","_prepareSprites","keptSprites","removedSprites","sentSprites","receivedSprites","beacons","sprites","forEach","set","prepareSprite","map","_prepared","has","add"],"mappings":"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"}