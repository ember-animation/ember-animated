{"version":3,"file":"motion.js","sources":["../../src/-private/motion.ts"],"sourcesContent":["import { spawnChild } from './scheduler.ts';\nimport { rAF, microwait } from './concurrency-helpers.ts';\nimport { continuedFromElement } from './motion-bridge.ts';\nimport TransitionContext from './transition-context.ts';\nimport type Sprite from './sprite.ts';\nimport { getOrCreate } from './singleton.ts';\n\nconst motions = getOrCreate<WeakMap<Element, Motion[]>>(\n  'motion',\n  () => new WeakMap(),\n);\n\nexport interface BaseOptions {\n  duration: number;\n}\n\nexport interface MotionConstructor<T extends BaseOptions = BaseOptions> {\n  new (sprite: Sprite, opts: Partial<T>): Motion<T>;\n}\n\nexport default abstract class Motion<T extends BaseOptions = BaseOptions> {\n  private _motionList: Motion[] | undefined;\n  private _inheritedMotionList: Motion[] | undefined;\n\n  constructor(\n    readonly sprite: Sprite,\n    readonly opts: Partial<T> = {},\n  ) {\n    this.sprite = sprite;\n    this.opts = opts;\n    this._setupMotionList();\n  }\n\n  // All motions should read this to decide how long to animate. It allows users\n  // to set a duration explicitly or rely on the prevailing default for the\n  // whole running transition.\n  get duration(): number {\n    if (this.opts.duration != null) {\n      return this.opts.duration;\n    }\n    return TransitionContext.forSprite(this.sprite).duration;\n  }\n\n  run() {\n    let context = TransitionContext.forSprite(this.sprite);\n    // eslint-disable-next-line @typescript-eslint/no-this-alias\n    let self = this;\n    return spawnChild(function* () {\n      context.onMotionStart(self.sprite);\n      try {\n        yield* self._run();\n      } finally {\n        context.onMotionEnd(self.sprite);\n      }\n    });\n  }\n\n  // --- Begin Hooks you should Implement ---\n\n  // Here you can inspect the other motions on this element that have\n  // been interrupted during this frame. You should save any state on\n  // `this` in order to influence your own animation. This hook is\n  // skipped if there were no other motions.\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  interrupted(_otherMotions: Motion[]): void {}\n\n  // Implement your animation here. It must be a generator function\n  // that yields promises (just like an ember-concurrency task, except\n  // you don't need to wrap in `task()` here and you therefore don't\n  // get the extra features provided by EC tasks.\n  *animate(): Generator<Promise<unknown>, void, unknown> {}\n\n  // --- Begin private methods ---\n\n  *_run() {\n    try {\n      let others = this._motionList!.filter((m) => m !== this);\n      if (this._inheritedMotionList) {\n        others = others.concat(this._inheritedMotionList);\n      }\n      if (others.length > 0) {\n        this.interrupted(others);\n      }\n      yield* this.animate();\n    } finally {\n      rAF().then(() => this._clearMotionList());\n    }\n  }\n\n  _setupMotionList() {\n    let element = this.sprite.element;\n    let motionList = motions.get(element);\n    if (!motionList) {\n      motions.set(element, (motionList = []));\n    }\n    this._motionList = motionList;\n    // we wait here so that if multiple motions are started\n    // simultaneously, the latter ones don't see the earlier ones as\n    // interrupted.\n    microwait().then(() => {\n      if (this._motionList) {\n        this._motionList.unshift(this);\n      }\n    });\n    let oldElement = continuedFromElement(element);\n    if (oldElement) {\n      let inheritedMotions = motions.get(oldElement);\n      if (inheritedMotions) {\n        this._inheritedMotionList = inheritedMotions;\n      }\n    }\n  }\n\n  _clearMotionList() {\n    if (this._motionList) {\n      let index = this._motionList.indexOf(this);\n      this._motionList.splice(index, 1);\n      if (this._motionList.length === 0) {\n        motions.delete(this.sprite.element);\n      }\n      this._motionList = undefined;\n    }\n  }\n}\n"],"names":["motions","getOrCreate","WeakMap","Motion","constructor","sprite","opts","_defineProperty","_setupMotionList","duration","TransitionContext","forSprite","run","context","self","spawnChild","onMotionStart","_run","onMotionEnd","interrupted","_otherMotions","animate","others","_motionList","filter","m","_inheritedMotionList","concat","length","rAF","then","_clearMotionList","element","motionList","get","set","microwait","unshift","oldElement","continuedFromElement","inheritedMotions","index","indexOf","splice","delete","undefined"],"mappings":"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"}