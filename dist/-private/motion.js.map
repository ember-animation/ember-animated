{"version":3,"file":"motion.js","sources":["../../src/-private/motion.ts"],"sourcesContent":["import { spawnChild } from './scheduler.ts';\nimport { rAF, microwait } from './concurrency-helpers.ts';\nimport { continuedFromElement } from './motion-bridge.ts';\nimport TransitionContext from './transition-context.ts';\nimport type Sprite from './sprite.ts';\nimport { getOrCreate } from './singleton.ts';\n\nconst motions = getOrCreate<WeakMap<Element, Motion[]>>(\n  'motion',\n  () => new WeakMap(),\n);\n\nexport interface BaseOptions {\n  duration: number;\n}\n\nexport interface MotionConstructor<T extends BaseOptions = BaseOptions> {\n  new (sprite: Sprite, opts: Partial<T>): Motion<T>;\n}\n\nexport default abstract class Motion<T extends BaseOptions = BaseOptions> {\n  private _motionList: Motion[] | undefined;\n  private _inheritedMotionList: Motion[] | undefined;\n\n  constructor(\n    readonly sprite: Sprite,\n    readonly opts: Partial<T> = {},\n  ) {\n    this.sprite = sprite;\n    this.opts = opts;\n    this._setupMotionList();\n  }\n\n  // All motions should read this to decide how long to animate. It allows users\n  // to set a duration explicitly or rely on the prevailing default for the\n  // whole running transition.\n  get duration(): number {\n    if (this.opts.duration != null) {\n      return this.opts.duration;\n    }\n    return TransitionContext.forSprite(this.sprite).duration;\n  }\n\n  run() {\n    let context = TransitionContext.forSprite(this.sprite);\n    // eslint-disable-next-line @typescript-eslint/no-this-alias\n    let self = this;\n    return spawnChild(function* () {\n      context.onMotionStart(self.sprite);\n      try {\n        yield* self._run();\n      } finally {\n        context.onMotionEnd(self.sprite);\n      }\n    });\n  }\n\n  // --- Begin Hooks you should Implement ---\n\n  // Here you can inspect the other motions on this element that have\n  // been interrupted during this frame. You should save any state on\n  // `this` in order to influence your own animation. This hook is\n  // skipped if there were no other motions.\n  // eslint-disable-next-line @typescript-eslint/no-unused-vars\n  interrupted(_otherMotions: Motion[]): void {}\n\n  // Implement your animation here. It must be a generator function\n  // that yields promises (just like an ember-concurrency task, except\n  // you don't need to wrap in `task()` here and you therefore don't\n  // get the extra features provided by EC tasks.\n  *animate(): Generator<Promise<unknown>, void, unknown> {}\n\n  // --- Begin private methods ---\n\n  *_run() {\n    try {\n      let others = this._motionList!.filter((m) => m !== this);\n      if (this._inheritedMotionList) {\n        others = others.concat(this._inheritedMotionList);\n      }\n      if (others.length > 0) {\n        this.interrupted(others);\n      }\n      yield* this.animate();\n    } finally {\n      rAF().then(() => this._clearMotionList());\n    }\n  }\n\n  _setupMotionList() {\n    let element = this.sprite.element;\n    let motionList = motions.get(element);\n    if (!motionList) {\n      motions.set(element, (motionList = []));\n    }\n    this._motionList = motionList;\n    // we wait here so that if multiple motions are started\n    // simultaneously, the latter ones don't see the earlier ones as\n    // interrupted.\n    microwait().then(() => {\n      if (this._motionList) {\n        this._motionList.unshift(this);\n      }\n    });\n    let oldElement = continuedFromElement(element);\n    if (oldElement) {\n      let inheritedMotions = motions.get(oldElement);\n      if (inheritedMotions) {\n        this._inheritedMotionList = inheritedMotions;\n      }\n    }\n  }\n\n  _clearMotionList() {\n    if (this._motionList) {\n      let index = this._motionList.indexOf(this);\n      this._motionList.splice(index, 1);\n      if (this._motionList.length === 0) {\n        motions.delete(this.sprite.element);\n      }\n      this._motionList = undefined;\n    }\n  }\n}\n"],"names":["motions","getOrCreate","WeakMap","Motion","_motionList","_inheritedMotionList","constructor","sprite","opts","_setupMotionList","duration","TransitionContext","forSprite","run","context","self","spawnChild","onMotionStart","_run","onMotionEnd","interrupted","_otherMotions","animate","others","filter","m","concat","length","rAF","then","_clearMotionList","element","motionList","get","set","microwait","unshift","oldElement","continuedFromElement","inheritedMotions","index","indexOf","splice","delete","undefined"],"mappings":"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"}