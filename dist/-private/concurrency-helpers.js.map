{"version":3,"file":"concurrency-helpers.js","sources":["../../src/-private/concurrency-helpers.ts"],"sourcesContent":["import { schedule, cancel } from '@ember/runloop';\nimport type { EmberRunTimer } from '@ember/runloop/types';\nimport { getOrCreate as _getOrCreate } from './singleton.ts';\n\nfunction getOrCreate<T>(key: string, construct: () => T): T {\n  return _getOrCreate(`concurrency-helpers.${key}`, construct);\n}\n\ninterface iFrameState {\n  nextFrame: number | null;\n  currentFrameClock: number;\n  nextFrameWaiters: { promise: Promise<any>; resolve: () => void }[];\n}\n\nexport const frameState = getOrCreate(\n  'frameState',\n  () =>\n    ({\n      nextFrame: null,\n      nextFrameWaiters: [],\n      // rAF guarantees that callbacks within the same frame will see the\n      // same clock. We stash it here so that arbitrary code can easily ask\n      // \"did I already do that this frame?\" without needing to thread the\n      // clock values around.\n      currentFrameClock: -Infinity,\n    }) as iFrameState,\n);\n\nconst cancellation = getOrCreate<\n  WeakMap<Promise<any>, (p: Promise<any>) => void>\n>('cancellation', () => new WeakMap());\n\nexport function registerCancellation(\n  promise: Promise<any>,\n  handler: (p: Promise<any>) => void,\n) {\n  cancellation.set(promise, handler);\n}\n\nexport function fireCancellation(promise: Promise<any>) {\n  let fn = cancellation.get(promise);\n  if (fn) {\n    fn(promise);\n  }\n}\n\n// This is a cancelable way to requestAnimationFrame that's designed\n// to resolve via the microtask queue (like real spec-compliant\n// Promises are supposed to). This lets us use rAF within\n// ember-concurrency correctly. RSVP promises within Ember do not\n// resolve on the microtask queue, because Ember schedules them inside\n// backburner.\nexport function rAF() {\n  if (!frameState.nextFrame) {\n    frameState.nextFrame = requestAnimationFrame(rAFDidFire);\n  }\n  let resolve;\n  let promise = new Promise((r) => {\n    resolve = r;\n  });\n  frameState.nextFrameWaiters.push({\n    resolve: resolve as any as () => void,\n    promise,\n  });\n  registerCancellation(promise, removeWaiter);\n  return promise;\n}\n\nfunction rAFDidFire(clock: number) {\n  frameState.nextFrame = null;\n  frameState.currentFrameClock = clock;\n  let waiters = frameState.nextFrameWaiters;\n  frameState.nextFrameWaiters = [];\n  for (const waiter of waiters) {\n    waiter.resolve();\n  }\n}\n\nfunction removeWaiter(promise: Promise<any>) {\n  let pair = frameState.nextFrameWaiters.find(\n    (pair) => pair.promise === promise,\n  );\n  if (pair) {\n    let index = frameState.nextFrameWaiters.indexOf(pair);\n    if (index > -1) {\n      frameState.nextFrameWaiters.splice(index, 1);\n    }\n  }\n}\n\nexport function microwait(): Promise<void> {\n  return new Promise((resolve) => resolve());\n}\n\nexport function wait(ms = 0): Promise<void> {\n  if (clock.now === originalClock) {\n    let ticket: number;\n    let promise = new Promise<void>((resolve) => {\n      ticket = window.setTimeout(resolve, ms);\n    });\n    registerCancellation(promise, () => {\n      clearTimeout(ticket);\n    });\n    return promise;\n  } else {\n    let canceled = false;\n    let started = clock.now();\n    let promise = new Promise<void>((resolve) => {\n      function checkIt() {\n        if (!canceled) {\n          if (clock.now() - started > ms) {\n            resolve();\n          }\n          rAF().then(checkIt);\n        }\n      }\n      checkIt();\n    });\n    registerCancellation(promise, () => {\n      canceled = true;\n    });\n    return promise;\n  }\n}\n\nexport function afterRender() {\n  let ticket: EmberRunTimer;\n  let promise = new Promise<void>((resolve) => {\n    ticket = schedule('afterRender', () => resolve());\n  });\n  registerCancellation(promise, () => {\n    cancel(ticket);\n  });\n  return promise;\n}\n\n// This provides a unified place to hook into time control for testing.\nexport let clock = getOrCreate('clock', () => ({\n  now() {\n    return new Date().getTime();\n  },\n}));\n\nconst originalClock = getOrCreate('originalClock', () => clock.now);\n\nexport function allSettled(promises: Promise<any>[]) {\n  return Promise.all(\n    promises.map((p) => {\n      if (p) {\n        return p.catch(() => null);\n      }\n      return;\n    }),\n  );\n}\n"],"names":["getOrCreate","key","construct","_getOrCreate","frameState","nextFrame","nextFrameWaiters","currentFrameClock","Infinity","cancellation","WeakMap","registerCancellation","promise","handler","set","fireCancellation","fn","get","rAF","requestAnimationFrame","rAFDidFire","resolve","Promise","r","push","removeWaiter","clock","waiters","waiter","pair","find","index","indexOf","splice","microwait","wait","ms","now","originalClock","ticket","window","setTimeout","clearTimeout","canceled","started","checkIt","then","afterRender","schedule","cancel","Date","getTime","allSettled","promises","all","map","p","catch"],"mappings":"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"}