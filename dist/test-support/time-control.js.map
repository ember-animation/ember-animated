{"version":3,"file":"time-control.js","sources":["../../src/test-support/time-control.js"],"sourcesContent":["import { clock, rAF } from '../-private/concurrency-helpers.ts';\nimport { getOrCreate } from '../-private/singleton.ts';\n\nlet origNow = getOrCreate('time-control', () => clock.now);\n\nexport default class TimeControl {\n  constructor() {\n    if (clock.now !== origNow) {\n      throw new Error('Only one TimeControl may be active at a time');\n    }\n    this._timer = origNow();\n    this._runningSpeed = false;\n    this._runStartedAt = null;\n    clock.now = () => this.now();\n  }\n  finished() {\n    clock.now = origNow;\n  }\n  now() {\n    if (this._runningSpeed) {\n      return (\n        (origNow() - this._runStartedAt) * this._runningSpeed + this._timer\n      );\n    }\n    return this._timer;\n  }\n  advance(ms) {\n    if (this._runningSpeed) {\n      throw new Error(\n        \"You can't advance a running TimeControl. Use either runAtSpeed or advance but not both at once.\",\n      );\n    }\n    this._timer += ms;\n    // This waits for three frames because:\n    //\n    //   1. You need at least two rAFs to guarantee that everybody\n    //   else who is running at rAF frequency had a chance to run\n    //   (because you don't know which ones ran before you in the same\n    //   frame).\n    //\n    //   2. Our Tween system doesn't mark Tweens as done until they\n    //   had a whole frame in their \"done\" state (see comments in\n    //   ./tween.js).\n    return rAF().then(rAF).then(rAF);\n  }\n  runAtSpeed(factor) {\n    this._timer = this.now();\n    this._runningSpeed = factor;\n    this._runStartedAt = origNow();\n  }\n  pause() {\n    this._timer = this.now();\n    this._runningSpeed = false;\n    this._runstartedAt = null;\n  }\n}\n"],"names":["origNow","getOrCreate","clock","now","TimeControl","constructor","Error","_timer","_runningSpeed","_runStartedAt","finished","advance","ms","rAF","then","runAtSpeed","factor","pause","_runstartedAt"],"mappings":";;;AAGA,IAAIA,OAAO,GAAGC,WAAW,CAAC,cAAc,EAAE,MAAMC,KAAK,CAACC,GAAG,CAAC;AAE3C,MAAMC,WAAW,CAAC;AAC/BC,EAAAA,WAAWA,GAAG;AACZ,IAAA,IAAIH,KAAK,CAACC,GAAG,KAAKH,OAAO,EAAE;AACzB,MAAA,MAAM,IAAIM,KAAK,CAAC,8CAA8C,CAAC;AACjE;AACA,IAAA,IAAI,CAACC,MAAM,GAAGP,OAAO,EAAE;IACvB,IAAI,CAACQ,aAAa,GAAG,KAAK;IAC1B,IAAI,CAACC,aAAa,GAAG,IAAI;IACzBP,KAAK,CAACC,GAAG,GAAG,MAAM,IAAI,CAACA,GAAG,EAAE;AAC9B;AACAO,EAAAA,QAAQA,GAAG;IACTR,KAAK,CAACC,GAAG,GAAGH,OAAO;AACrB;AACAG,EAAAA,GAAGA,GAAG;IACJ,IAAI,IAAI,CAACK,aAAa,EAAE;AACtB,MAAA,OACE,CAACR,OAAO,EAAE,GAAG,IAAI,CAACS,aAAa,IAAI,IAAI,CAACD,aAAa,GAAG,IAAI,CAACD,MAAM;AAEvE;IACA,OAAO,IAAI,CAACA,MAAM;AACpB;EACAI,OAAOA,CAACC,EAAE,EAAE;IACV,IAAI,IAAI,CAACJ,aAAa,EAAE;AACtB,MAAA,MAAM,IAAIF,KAAK,CACb,iGACF,CAAC;AACH;IACA,IAAI,CAACC,MAAM,IAAIK,EAAE;AACjB;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA,IAAA,OAAOC,GAAG,EAAE,CAACC,IAAI,CAACD,GAAG,CAAC,CAACC,IAAI,CAACD,GAAG,CAAC;AAClC;EACAE,UAAUA,CAACC,MAAM,EAAE;AACjB,IAAA,IAAI,CAACT,MAAM,GAAG,IAAI,CAACJ,GAAG,EAAE;IACxB,IAAI,CAACK,aAAa,GAAGQ,MAAM;AAC3B,IAAA,IAAI,CAACP,aAAa,GAAGT,OAAO,EAAE;AAChC;AACAiB,EAAAA,KAAKA,GAAG;AACN,IAAA,IAAI,CAACV,MAAM,GAAG,IAAI,CAACJ,GAAG,EAAE;IACxB,IAAI,CAACK,aAAa,GAAG,KAAK;IAC1B,IAAI,CAACU,aAAa,GAAG,IAAI;AAC3B;AACF;;;;"}